<!-- src/app/features/host/property-wizard/steps/step-pricing/step-pricing.component.html -->

<div class="step-pricing">
  <div class="step-intro">
    <h2>Set your price</h2>
    <p>AI-powered price suggestion based on your property features</p>
  </div>

  <form [formGroup]="form">

    <!-- ✅ AI PRICE SUGGESTION CARD -->
    <div class="section ai-suggestion-card">
      <div class="card-header">
        <mat-icon>psychology</mat-icon>
        <h3>AI Price Suggestion</h3>
      </div>

      <!-- Loading state -->
      <div *ngIf="loadingPrediction" class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Analyzing market data...</p>
      </div>

      <!-- Error state -->
      <div *ngIf="predictionError && !loadingPrediction" class="error-state">
        <mat-icon>error_outline</mat-icon>
        <p>{{ predictionError }}</p>
        <button mat-stroked-button (click)="loadPricePrediction()">
          <mat-icon>refresh</mat-icon>
          Retry
        </button>
      </div>

      <!-- Success state -->
      <div *ngIf="prediction && !loadingPrediction" class="prediction-result">
        <!-- Prix suggéré en ETH (principal) -->
        <div class="suggested-price">
          <span class="label">Suggested price</span>
          <span class="price">{{ prediction.predicted_price_eth | number:'1.4-4' }} ETH</span>
          <span class="per-night">/ night</span>
        </div>

        <!-- Conversion EUR (secondaire) -->
        <div class="price-conversion">
          ≈ {{ prediction.predicted_price_eur | number:'1.0-0' }} EUR
        </div>

        <!-- Fourchette de confiance en ETH -->
        <div class="confidence-range" *ngIf="prediction.confidence_range_eth">
          <span class="label">Optimal range:</span>
          <span class="range">
            {{ prediction.confidence_range_eth.min | number:'1.4-4' }} -
            {{ prediction.confidence_range_eth.max | number:'1.4-4' }} ETH
          </span>
        </div>

        <!-- Fourchette EUR (optionnel) -->
        <div class="confidence-range-eur" *ngIf="prediction.confidence_range_eur">
          <span class="range-eur">
            ({{ prediction.confidence_range_eur.min | number:'1.0-0' }} -
            {{ prediction.confidence_range_eur.max | number:'1.0-0' }} EUR)
          </span>
        </div>

        <!-- Recommandation -->
        <div class="recommendation" *ngIf="prediction.recommendation">
          <mat-icon>lightbulb</mat-icon>
          <span>{{ prediction.recommendation }}</span>
        </div>

        <button mat-raised-button color="primary" (click)="applyPredictedPrice()" type="button">
          Apply suggested price
        </button>
      </div>
    </div>

    <!-- Main Pricing (EN ETH) -->
    <div class="section pricing-main">
      <h3>Your price</h3>

      <div class="price-input-large">
        <input
          type="number"
          formControlName="pricePerNight"
          min="0.0001"
          step="0.0001"
          class="price-field"
          placeholder="0.0000"
        >
        <span class="currency">ETH</span>
        <span class="per-night">/ night</span>
      </div>

      <!-- Conversion EUR en temps réel -->
      <div class="price-eur-conversion" *ngIf="form.get('pricePerNight')?.value">
        ≈ {{ getCurrentPriceEur() | number:'1.0-0' }} EUR / night
      </div>

      <!-- Price validation message -->
      <div *ngIf="prediction && form.get('pricePerNight')?.value"
           class="price-validation"
           [class.valid]="isPriceInRange()"
           [class.invalid]="!isPriceInRange()">
        <mat-icon>{{ isPriceInRange() ? 'check_circle' : 'info' }}</mat-icon>
        <span>{{ getPriceMessage() }}</span>
      </div>

      <div class="earnings-estimate">
        <mat-icon>trending_up</mat-icon>
        <div class="earnings-content">
          <span>Estimated monthly earnings:</span>
          <strong>{{ getEstimatedEarningsEth() | number:'1.4-4' }} ETH</strong>
          <span class="earnings-eur">(≈ {{ getEstimatedEarningsEur() | number:'1.0-0' }} EUR)</span>
        </div>
      </div>
    </div>

    <!-- Weekend Price -->
    <div class="section">
      <h3>Weekend price</h3>
      <p class="section-hint">Set a different price for Friday and Saturday nights</p>

      <mat-form-field appearance="outline" class="price-field-small">
        <mat-label>Weekend price per night</mat-label>
        <input matInput
               type="number"
               formControlName="weekendPricePerNight"
               min="0.0001"
               step="0.0001">
        <span matTextSuffix>ETH</span>
      </mat-form-field>

      <!-- Conversion EUR pour weekend -->
      <div class="weekend-eur-hint" *ngIf="form.get('weekendPricePerNight')?.value">
        ≈ {{ (form.get('weekendPricePerNight')?.value * ethToEurRate) | number:'1.0-0' }} EUR
      </div>
    </div>

    <!-- Additional Fees -->
    <div class="section">
      <h3>Additional fees (optional)</h3>

      <div class="fees-grid">
        <mat-form-field appearance="outline">
          <mat-label>Cleaning fee</mat-label>
          <input matInput type="number" formControlName="cleaningFee" min="0" step="0.0001">
          <span matTextSuffix>ETH</span>
          <mat-hint>One-time fee</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Pet fee</mat-label>
          <input matInput type="number" formControlName="petFee" min="0" step="0.0001">
          <span matTextSuffix>ETH</span>
          <mat-hint>Per stay</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <!-- Stay Length -->
    <div class="section">
      <h3>Stay length</h3>

      <div class="fees-grid">
        <mat-form-field appearance="outline">
          <mat-label>Minimum nights</mat-label>
          <input matInput type="number" formControlName="minStayNights" min="1">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Maximum nights</mat-label>
          <input matInput type="number" formControlName="maxStayNights" min="1">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Booking advance (days)</mat-label>
          <input matInput type="number" formControlName="bookingAdvanceDays" min="0">
          <mat-hint>How far in advance guests can book</mat-hint>
        </mat-form-field>
      </div>
    </div>
  </form>
</div>
